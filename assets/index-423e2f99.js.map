{"version":3,"file":"index-423e2f99.js","sources":["../../../packages/component/src/useForm/index.ts"],"sourcesContent":["import { shallowRef, unref, toRaw, reactive } from 'vue'\nimport { isUndefined, cloneDeep } from 'lodash-es'\nimport { FormItemProps, FormInstance } from 'element-plus'\nimport { FormColumn as OriginFormColumn } from '../Form'\nimport { ExpandColumn, ExcludeColumn } from '../useColumn'\n\nexport type UseFormColumn = ExpandColumn<\n  ExcludeColumn<OriginFormColumn, 'formItemProps'>,\n  Partial<Omit<FormItemProps, 'prop' | 'required'>> & {\n    hidden?: boolean\n    requiredMsg?: string\n    formItemProps?: OriginFormColumn['formItemProps']\n  }\n>\nexport interface FormState<T> {\n  submitting: boolean\n  columns: OriginFormColumn[]\n  model: T\n  // FIXME: 修复 tsconfig.json strict: true 下报错的问题\n  ref?: any\n}\n\nexport type IFormColumn = ExpandColumn<OriginFormColumn, { hidden?: boolean }>\n\nexport const formatFormColumn = (column: UseFormColumn) => {\n  // FIXME: 移除label 使其在传递中保持响应式\n  const { prop, formItemProps, labelWidth, rules, requiredMsg, ...other } = column\n\n  const newColumn: IFormColumn = {\n    ...other,\n    prop,\n    formItemProps: {\n      prop,\n      labelWidth,\n      rules: rules\n        ? rules\n        : requiredMsg\n        ? [\n            {\n              required: true,\n              message: requiredMsg,\n            },\n          ]\n        : void 0,\n      ...formItemProps,\n    },\n  }\n\n  return newColumn\n}\n\nexport interface UseFormOptions<T> {\n  columns: UseFormColumn[]\n  initData?: Partial<T>\n}\n\nexport type SubmitPost<T> = (model: T) => any\n\nexport function useForm<T extends object>(opts: UseFormOptions<T>) {\n  /**\n   * el-form 组件实例\n   */\n  const formRef = shallowRef<FormInstance | null>(null)\n  const originColumns = shallowRef(opts.columns.map((i) => formatFormColumn(i)))\n  const formState: FormState<T> = reactive({\n    submitting: false,\n    // FIXME: Type instantiation is excessively deep and possibly infinite\n    model: { ...(opts.initData ?? null) } as any,\n    columns: unref(originColumns).filter((i) => !i.hidden) as any[],\n    ref(instance: any) {\n      formRef.value = instance?.elForm\n    },\n  })\n\n  /**\n   * 通过prop获取列\n   */\n  const getColumn = (prop: UseFormColumn['prop']) => {\n    for (const i of unref(originColumns)) {\n      if (i.prop === prop) {\n        return i\n      }\n    }\n    return null\n  }\n\n  /**\n   * 通过prop设置列的属性\n   * newVal 可以设置当前prop的表单值\n   */\n  const setColumn = (\n    prop: UseFormColumn['prop'],\n    obj: Partial<ExcludeColumn<UseFormColumn, 'hidden'>> | null,\n    newVal?: any\n  ) => {\n    for (const column of formState.columns) {\n      if (column.prop === prop) {\n        for (const originColumn of opts.columns) {\n          if (originColumn.prop === prop) {\n            const copyColumn = cloneDeep(originColumn)\n            const newColumn = formatFormColumn(Object.assign(copyColumn, obj))\n\n            Object.assign(column, newColumn)\n            break\n          }\n        }\n        break\n      }\n    }\n\n    if (!isUndefined(newVal)) {\n      formState.model[prop as keyof FormState<T>['model']] = newVal\n    }\n  }\n\n  /**\n   * 用于快速更新表单项状态 避免 setColumn 性能问题\n   */\n  const patchColumn = (column: IFormColumn, patch?: Partial<ExcludeColumn<UseFormColumn, 'prop'>>) => {\n    if (patch) {\n      const newColumn = formatFormColumn({\n        ...patch,\n        prop: column.prop,\n        formItemProps: column.formItemProps,\n      } as UseFormColumn)\n\n      Object.assign(column, newColumn)\n    }\n  }\n\n  /**\n   * 表单项的显示隐藏\n   */\n  const toggleColumn = (\n    prop: UseFormColumn['prop'] | UseFormColumn['prop'][] | Record<UseFormColumn['prop'], boolean>,\n    show?: boolean\n  ) => {\n    if (!prop) return\n\n    type KMap = Record<NonNullable<UseFormColumn['prop']>, boolean | undefined>\n\n    const propMap: KMap =\n      typeof prop === 'string'\n        ? ({ [prop]: show } as KMap)\n        : !Array.isArray(prop)\n        ? prop\n        : prop.reduce((map, i) => {\n            !!i && (map[i] = show)\n            return map\n          }, {} as KMap)\n    const newColumns: FormState<T>['columns'] = []\n\n    for (const column of unref(originColumns)) {\n      const iProp = column.prop as NonNullable<UseFormColumn['prop']>\n\n      if (iProp && iProp in propMap) {\n        column.hidden = isUndefined(propMap[iProp]) ? !column.hidden : !propMap[iProp]\n      }\n\n      !column.hidden && newColumns.push(column)\n    }\n\n    formState.columns = newColumns\n  }\n\n  /**\n   * 表单提交\n   */\n  const submit = async (post?: (model: T) => any) => {\n    try {\n      formState.submitting = true\n\n      const valid = (await formRef.value?.validate()) ?? true\n\n      if (valid && post) await post(cloneDeep(toRaw(formState.model)))\n\n      formState.submitting = false\n    } catch (error) {\n      formState.submitting = false\n\n      throw error\n    }\n  }\n\n  /**\n   * 设置表单状态\n   * isReset为true时会重置表单项\n   */\n  const setModel = (obj: Partial<T>, isReset = false) => {\n    if (isReset) {\n      formState.model = cloneDeep(toRaw(obj)) as T\n      formState.columns = unref(originColumns).filter((i) => !i.hidden)\n      // FIXME: resetFields or clearValidate 在useLayout里使用同一个表单实现新增和修改操作 每次打开时要重置表单\n      formRef.value?.resetFields()\n      return\n    }\n    formState.model = { ...formState.model, ...obj }\n  }\n\n  const getModel = <K extends keyof T = keyof T>(key: K): T[K] => {\n    return formState.model[key]\n  }\n\n  return {\n    formState,\n    getColumn,\n    setColumn,\n    toggleColumn,\n    submit,\n    setModel,\n    form: formRef,\n    getModel,\n    patchColumn,\n    originColumns,\n  }\n}\n"],"names":["formatFormColumn","column","prop","formItemProps","labelWidth","rules","requiredMsg","other","useForm","opts","formRef","shallowRef","originColumns","i","formState","reactive","unref","instance","obj","newVal","originColumn","copyColumn","cloneDeep","newColumn","isUndefined","show","propMap","map","newColumns","iProp","post","_a","toRaw","error","isReset","key","patch"],"mappings":"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"}