{"version":3,"file":"index-a2564e87.js","sources":["../../../packages/component/src/useForm/index.ts"],"sourcesContent":["import { ref, unref, toRaw, reactive, shallowReactive } from 'vue'\nimport { isUndefined, cloneDeep } from 'lodash-es'\nimport { FormItemProps, FormInstance } from 'element-plus'\nimport { FormColumn as OriginFormColumn } from '../Form'\nimport { ExpandColumn, ExcludeColumn } from '../useColumn'\n\nexport type UseFormColumn = ExpandColumn<\n  ExcludeColumn<OriginFormColumn, 'formItemProps'>,\n  Partial<Omit<FormItemProps, 'prop' | 'required'>> & {\n    hidden?: boolean\n    requiredMsg?: string\n    formItemProps?: OriginFormColumn['formItemProps']\n  }\n>\nexport interface FormState<T> {\n  submitting: boolean\n  columns: OriginFormColumn[]\n  model: T\n  // FIXME: 修复 tsconfig.json strict: true 下报错的问题\n  ref?: any\n}\n\ntype FormColumn = ExpandColumn<OriginFormColumn, { hidden?: boolean }>\n\nexport const formatFormColumn = (column: UseFormColumn) => {\n  const { prop, formItemProps, label, labelWidth, rules, requiredMsg, ...other } = column\n\n  const newColumn: FormColumn = {\n    ...other,\n    prop,\n    formItemProps: {\n      prop,\n      label,\n      labelWidth,\n      rules: rules\n        ? rules\n        : requiredMsg\n        ? [\n            {\n              required: true,\n              message: requiredMsg,\n            },\n          ]\n        : [],\n      ...formItemProps,\n    },\n  }\n\n  return newColumn\n}\n\nexport interface UseFormOptions<T> {\n  columns: UseFormColumn[]\n  initData?: Partial<T>\n}\n\nexport type SubmitPost<T> = (model: T) => any\n\nexport function useForm<T extends object>(opts: UseFormOptions<T>) {\n  /**\n   * el-form 组件实例\n   */\n  const formRef = ref<FormInstance | null>(null)\n  const originColumn = shallowReactive(opts.columns.map((i) => formatFormColumn(i)))\n  const formState: FormState<T> = reactive({\n    submitting: false,\n    // FIXME: Type instantiation is excessively deep and possibly infinite\n    model: { ...(opts.initData ?? null) } as any,\n    columns: originColumn.filter((i) => !i.hidden) as any[],\n    ref(instance: any) {\n      formRef.value = instance?.elForm\n    },\n  })\n\n  /**\n   * 通过prop获取列\n   */\n  const getColumn = (prop: UseFormColumn['prop']) => {\n    for (const i of originColumn) {\n      if (i.prop === prop) {\n        return i\n      }\n    }\n    return null\n  }\n\n  /**\n   * 通过prop设置列的属性\n   * newVal 可以设置当前prop的表单值\n   */\n  const setColumn = (\n    prop: UseFormColumn['prop'],\n    obj: Partial<ExcludeColumn<UseFormColumn, 'hidden'>> | null,\n    newVal?: any\n  ) => {\n    for (const column of formState.columns) {\n      if (column.prop === prop) {\n        for (const originColumn of opts.columns) {\n          if (originColumn.prop === prop) {\n            const copyColumn = cloneDeep(originColumn)\n            const newColumn = formatFormColumn(Object.assign(copyColumn, obj))\n\n            Object.assign(column, newColumn)\n            break\n          }\n        }\n        break\n      }\n    }\n\n    if (!isUndefined(newVal)) {\n      formState.model[prop as keyof FormState<T>['model']] = newVal\n    }\n  }\n\n  /**\n   * 表单项的显示隐藏\n   */\n  const toggleColumn = (\n    prop: UseFormColumn['prop'] | UseFormColumn['prop'][] | Record<UseFormColumn['prop'], boolean>,\n    show?: boolean\n  ) => {\n    if (!prop) return\n\n    type KMap = Record<NonNullable<UseFormColumn['prop']>, boolean | undefined>\n\n    const propMap: KMap =\n      typeof prop === 'string'\n        ? ({ [prop]: show } as KMap)\n        : !Array.isArray(prop)\n        ? prop\n        : prop.reduce((map, i) => {\n            !!i && (map[i] = show)\n            return map\n          }, {} as KMap)\n    const newColumns: FormState<T>['columns'] = []\n\n    for (const column of originColumn) {\n      const iProp = column.prop as NonNullable<UseFormColumn['prop']>\n\n      if (iProp && iProp in propMap) {\n        column.hidden = isUndefined(propMap[iProp]) ? !column.hidden : !propMap[iProp]\n      }\n\n      !column.hidden && newColumns.push(column)\n    }\n\n    formState.columns = newColumns\n  }\n\n  /**\n   * 表单提交\n   */\n  const submit = async (post?: (model: T) => any) => {\n    try {\n      formState.submitting = true\n\n      const valid = (await formRef.value?.validate()) ?? true\n\n      if (valid && post) await post(toRaw(unref(formState.model)))\n\n      formState.submitting = false\n    } catch (error) {\n      formState.submitting = false\n\n      throw error\n    }\n  }\n\n  /**\n   * 设置表单状态\n   * isReset为true时会重置表单项\n   */\n  const setModel = (obj: Partial<T>, isReset = false) => {\n    if (isReset) {\n      formState.model = obj as T\n      formState.columns = originColumn.filter((i) => !i.hidden)\n      formRef.value?.resetFields()\n      return\n    }\n    formState.model = { ...formState.model, ...obj }\n  }\n\n  const getModel = (key: keyof T) => {\n    return formState.model[key]\n  }\n\n  return {\n    formState,\n    getColumn,\n    setColumn,\n    toggleColumn,\n    submit,\n    setModel,\n    form: formRef,\n    getModel,\n  }\n}\n"],"names":["formatFormColumn","column","prop","formItemProps","label","labelWidth","rules","requiredMsg","other","useForm","opts","formRef","ref","originColumn","shallowReactive","i","formState","reactive","instance","obj","newVal","copyColumn","cloneDeep","newColumn","isUndefined","show","propMap","map","newColumns","iProp","post","_a","toRaw","unref","error","isReset","key"],"mappings":"2KAwBa,MAAAA,EAAoBC,GAA0B,CACnD,KAAA,CAAE,KAAAC,EAAM,cAAAC,EAAe,MAAAC,EAAO,WAAAC,EAAY,MAAAC,EAAO,YAAAC,EAAa,GAAGC,CAAU,EAAAP,EAuB1E,MArBuB,CAC5B,GAAGO,EACH,KAAAN,EACA,cAAe,CACb,KAAAA,EACA,MAAAE,EACA,WAAAC,EACA,MAAOC,IAEHC,EACA,CACE,CACE,SAAU,GACV,QAASA,CACX,CAAA,EAEF,CAAC,GACL,GAAGJ,CACL,CAAA,CAIJ,EASO,SAASM,EAA0BC,EAAyB,CAI3D,MAAAC,EAAUC,EAAyB,IAAI,EACvCC,EAAeC,EAAgBJ,EAAK,QAAQ,IAAKK,GAAMf,EAAiBe,CAAC,CAAC,CAAC,EAC3EC,EAA0BC,EAAS,CACvC,WAAY,GAEZ,MAAO,CAAE,GAAIP,EAAK,UAAY,IAAM,EACpC,QAASG,EAAa,OAAQE,GAAM,CAACA,EAAE,MAAM,EAC7C,IAAIG,EAAe,CACjBP,EAAQ,MAAQO,GAAA,YAAAA,EAAU,MAC5B,CAAA,CACD,EAmHM,MAAA,CACL,UAAAF,EACA,UAhHiBd,GAAgC,CACjD,UAAWa,KAAKF,EACV,GAAAE,EAAE,OAASb,EACN,OAAAa,EAGJ,OAAA,IAAA,EA2GP,UApGgB,CAChBb,EACAiB,EACAC,IACG,CACQ,UAAAnB,KAAUe,EAAU,QACzB,GAAAf,EAAO,OAASC,EAAM,CACbW,UAAAA,KAAgBH,EAAK,QAC1BG,GAAAA,EAAa,OAASX,EAAM,CACxB,MAAAmB,EAAaC,EAAUT,CAAY,EACnCU,EAAYvB,EAAiB,OAAO,OAAOqB,EAAYF,CAAG,CAAC,EAE1D,OAAA,OAAOlB,EAAQsB,CAAS,EAC/B,MAGJ,MAICC,EAAYJ,CAAM,IACXJ,EAAA,MAAMd,CAAmC,EAAIkB,EACzD,EA+EA,aAzEmB,CACnBlB,EACAuB,IACG,CACH,GAAI,CAACvB,EAAM,OAIL,MAAAwB,EACJ,OAAOxB,GAAS,SACX,CAAE,CAACA,CAAI,EAAGuB,GACV,MAAM,QAAQvB,CAAI,EAEnBA,EAAK,OAAO,CAACyB,EAAKZ,KACdA,IAAMY,EAAIZ,CAAC,EAAIU,GACVE,GACN,CAAU,CAAA,EAJbzB,EAKA0B,EAAsC,CAAA,EAE5C,UAAW3B,KAAUY,EAAc,CACjC,MAAMgB,EAAQ5B,EAAO,KAEjB4B,GAASA,KAASH,IACbzB,EAAA,OAASuB,EAAYE,EAAQG,CAAK,CAAC,EAAI,CAAC5B,EAAO,OAAS,CAACyB,EAAQG,CAAK,GAG/E,CAAC5B,EAAO,QAAU2B,EAAW,KAAK3B,CAAM,EAG1Ce,EAAU,QAAUY,CAAA,EA6CpB,OAvCa,MAAOE,GAA6B,OAC7C,GAAA,CACFd,EAAU,WAAa,IAER,OAAMe,EAAApB,EAAQ,QAAR,YAAAoB,EAAe,aAAe,KAEtCD,GAAM,MAAMA,EAAKE,EAAMC,EAAMjB,EAAU,KAAK,CAAC,CAAC,EAE3DA,EAAU,WAAa,SAChBkB,GACP,MAAAlB,EAAU,WAAa,GAEjBkB,CACR,CAAA,EA2BA,SApBe,CAACf,EAAiBgB,EAAU,KAAU,OACrD,GAAIA,EAAS,CACXnB,EAAU,MAAQG,EAClBH,EAAU,QAAUH,EAAa,OAAQE,GAAM,CAACA,EAAE,MAAM,GACxDgB,EAAApB,EAAQ,QAAR,MAAAoB,EAAe,cACf,OAEFf,EAAU,MAAQ,CAAE,GAAGA,EAAU,MAAO,GAAGG,EAAI,EAc/C,KAAMR,EACN,SAZgByB,GACTpB,EAAU,MAAMoB,CAAG,CAW1B,CAEJ"}