{"version":3,"file":"index-de164c88.js","sources":["../../../packages/component/src/useForm/index.ts"],"sourcesContent":["import { shallowRef, unref, toRaw, reactive } from 'vue'\nimport { isUndefined, cloneDeep } from 'lodash-es'\nimport { FormItemProps, FormInstance } from 'element-plus'\nimport { FormColumn as OriginFormColumn } from '../Form'\nimport { ExpandColumn, ExcludeColumn } from '../useColumn'\n\nexport type UseFormColumn = ExpandColumn<\n  ExcludeColumn<OriginFormColumn, 'formItemProps'>,\n  Partial<Omit<FormItemProps, 'prop' | 'required'>> & {\n    hidden?: boolean\n    requiredMsg?: string\n    formItemProps?: OriginFormColumn['formItemProps']\n  }\n>\nexport interface FormState<T> {\n  submitting: boolean\n  columns: OriginFormColumn[]\n  model: T\n  // FIXME: 修复 tsconfig.json strict: true 下报错的问题\n  ref?: any\n}\n\nexport type IFormColumn = ExpandColumn<OriginFormColumn, { hidden?: boolean }>\n\nexport const formatFormColumn = (column: UseFormColumn) => {\n  const { prop, formItemProps, label, labelWidth, rules, requiredMsg, ...other } = column\n\n  const newColumn: IFormColumn = {\n    ...other,\n    prop,\n    formItemProps: {\n      prop,\n      label,\n      labelWidth,\n      rules: rules\n        ? rules\n        : requiredMsg\n        ? [\n            {\n              required: true,\n              message: requiredMsg,\n            },\n          ]\n        : void 0,\n      ...formItemProps,\n    },\n  }\n\n  return newColumn\n}\n\nexport interface UseFormOptions<T> {\n  columns: UseFormColumn[]\n  initData?: Partial<T>\n}\n\nexport type SubmitPost<T> = (model: T) => any\n\nexport function useForm<T extends object>(opts: UseFormOptions<T>) {\n  /**\n   * el-form 组件实例\n   */\n  const formRef = shallowRef<FormInstance | null>(null)\n  const originColumn = shallowRef(opts.columns.map((i) => formatFormColumn(i)))\n  const formState: FormState<T> = reactive({\n    submitting: false,\n    // FIXME: Type instantiation is excessively deep and possibly infinite\n    model: { ...(opts.initData ?? null) } as any,\n    columns: unref(originColumn).filter((i) => !i.hidden) as any[],\n    ref(instance: any) {\n      formRef.value = instance?.elForm\n    },\n  })\n\n  /**\n   * 通过prop获取列\n   */\n  const getColumn = (prop: UseFormColumn['prop']) => {\n    for (const i of unref(originColumn)) {\n      if (i.prop === prop) {\n        return i\n      }\n    }\n    return null\n  }\n\n  /**\n   * 通过prop设置列的属性\n   * newVal 可以设置当前prop的表单值\n   */\n  const setColumn = (\n    prop: UseFormColumn['prop'],\n    obj: Partial<ExcludeColumn<UseFormColumn, 'hidden'>> | null,\n    newVal?: any\n  ) => {\n    for (const column of formState.columns) {\n      if (column.prop === prop) {\n        for (const originColumn of opts.columns) {\n          if (originColumn.prop === prop) {\n            const copyColumn = cloneDeep(originColumn)\n            const newColumn = formatFormColumn(Object.assign(copyColumn, obj))\n\n            Object.assign(column, newColumn)\n            break\n          }\n        }\n        break\n      }\n    }\n\n    if (!isUndefined(newVal)) {\n      formState.model[prop as keyof FormState<T>['model']] = newVal\n    }\n  }\n\n  /**\n   * 用于快速更新表单项状态 避免 setColumn 性能问题\n   */\n  const patchColumn = (column: IFormColumn, patch?: Partial<ExcludeColumn<UseFormColumn, 'prop'>>) => {\n    if (patch) {\n      const newColumn = formatFormColumn({\n        ...patch,\n        prop: column.prop,\n        formItemProps: column.formItemProps,\n      } as UseFormColumn)\n\n      Object.assign(column, newColumn)\n    }\n  }\n\n  /**\n   * 表单项的显示隐藏\n   */\n  const toggleColumn = (\n    prop: UseFormColumn['prop'] | UseFormColumn['prop'][] | Record<UseFormColumn['prop'], boolean>,\n    show?: boolean\n  ) => {\n    if (!prop) return\n\n    type KMap = Record<NonNullable<UseFormColumn['prop']>, boolean | undefined>\n\n    const propMap: KMap =\n      typeof prop === 'string'\n        ? ({ [prop]: show } as KMap)\n        : !Array.isArray(prop)\n        ? prop\n        : prop.reduce((map, i) => {\n            !!i && (map[i] = show)\n            return map\n          }, {} as KMap)\n    const newColumns: FormState<T>['columns'] = []\n\n    for (const column of unref(originColumn)) {\n      const iProp = column.prop as NonNullable<UseFormColumn['prop']>\n\n      if (iProp && iProp in propMap) {\n        column.hidden = isUndefined(propMap[iProp]) ? !column.hidden : !propMap[iProp]\n      }\n\n      !column.hidden && newColumns.push(column)\n    }\n\n    formState.columns = newColumns\n  }\n\n  /**\n   * 表单提交\n   */\n  const submit = async (post?: (model: T) => any) => {\n    try {\n      formState.submitting = true\n\n      const valid = (await formRef.value?.validate()) ?? true\n\n      if (valid && post) await post(cloneDeep(toRaw(formState.model)))\n\n      formState.submitting = false\n    } catch (error) {\n      formState.submitting = false\n\n      throw error\n    }\n  }\n\n  /**\n   * 设置表单状态\n   * isReset为true时会重置表单项\n   */\n  const setModel = (obj: Partial<T>, isReset = false) => {\n    if (isReset) {\n      formState.model = cloneDeep(toRaw(obj)) as T\n      formState.columns = unref(originColumn).filter((i) => !i.hidden)\n      formRef.value?.resetFields()\n      return\n    }\n    formState.model = { ...formState.model, ...obj }\n  }\n\n  const getModel = (key: keyof T) => {\n    return formState.model[key]\n  }\n\n  return {\n    formState,\n    getColumn,\n    setColumn,\n    toggleColumn,\n    submit,\n    setModel,\n    form: formRef,\n    getModel,\n    patchColumn,\n  }\n}\n"],"names":["formatFormColumn","column","prop","formItemProps","label","labelWidth","rules","requiredMsg","other","useForm","opts","formRef","shallowRef","originColumn","i","formState","reactive","unref","instance","obj","newVal","copyColumn","cloneDeep","newColumn","isUndefined","show","propMap","map","newColumns","iProp","post","_a","toRaw","error","isReset","key","patch"],"mappings":"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"}