{"version":3,"file":"index-c1e67f32.js","sources":["../../../packages/component/src/useEditTable/index.ts"],"sourcesContent":["import { useTable, UseTableColumn, defaultFormatter, UseTableOptions, TableState } from '../useTable'\nimport { Column, useColumn, ExpandColumn } from '../useColumn'\nimport { cloneDeep, isUndefined, isEqual } from 'lodash-es'\nimport { readonly, computed, reactive, unref } from 'vue'\n\nexport type UseEditTableColumn<T> = ExpandColumn<Column, UseTableColumn<T> & { editable?: boolean }>\nexport interface EditTableRow {\n  _origin?: Omit<EditTableRow, '_editing' | '_delete' | '_origin'>\n  _editing?: boolean\n  _delete?: boolean\n  [key: string]: any\n}\n\nexport type UseEditTableOptions<T> = UseTableOptions<T, UseEditTableColumn<T>>\n\nexport const useEditTable = <T extends EditTableRow>(opts: UseTableOptions<T, UseEditTableColumn<T>>) => {\n  const renderColumn = useColumn()\n  const { tableState, ...other } = useTable<T, UseEditTableColumn<T>>({\n    mapColumn(i) {\n      const { formatter, editable, ...other } = i\n\n      return {\n        ...other,\n        formatter(row, column, cellValue, index) {\n          if ((isUndefined(editable) || editable === true) && (row as any)._editing) {\n            return renderColumn(row, i) ?? ''\n          }\n\n          if (formatter) return formatter(row, column, cellValue, index)\n\n          return defaultFormatter(cellValue, other.rFormat, other.defaultValue) ?? cellValue ?? other.defaultValue\n        },\n      }\n    },\n    ...opts,\n    async query(p) {\n      const res = await opts.query(p)\n\n      res.list = res.list.map((i) => {\n        const origin = cloneDeep(i)\n\n        return Object.assign(i, { _origin: readonly(origin) })\n      })\n\n      return res\n    },\n  })\n\n  const setColumn = (prop: Column['prop'], obj: Partial<UseEditTableColumn<T>>) => {\n    tableState.columns = tableState.columns.map((i) => {\n      if (i.prop === prop) return Object.assign(i, obj)\n\n      return i\n    })\n  }\n\n  const editRow = (row: T) => {\n    row._editing = true\n  }\n\n  const cancelRow = (row: T) => {\n    for (const key in row._origin) {\n      row[key as keyof T] = row._origin[key]\n    }\n    row._editing = false\n  }\n\n  const delRow = (row: T) => {\n    row._delete = true\n  }\n\n  const saveRow = (row: T) => {\n    row._editing = false\n  }\n\n  const addRow = (row?: Partial<T>) => {\n    // @ts-ignore\n    const newRow: T = { _editing: true, ...(row ?? null), _origin: void 0 }\n\n    tableState.data.push(newRow)\n\n    return newRow\n  }\n\n  const rowIsEditing = (row: T) => {\n    return !!row._editing\n  }\n\n  const rowIsAdded = (row: T) => {\n    return isUndefined(row._origin)\n  }\n\n  /**\n   * 分别对应 删除项, 新增项, 修改项\n   */\n  const getChangedRows = () => {\n    const added: T[] = []\n    const changed: T[] = []\n    const removed: T[] = []\n\n    for (const i of tableState.data) {\n      if (i._delete) {\n        if (!rowIsAdded(i)) {\n          removed.push(unref(i))\n        }\n      } else {\n        if (rowIsAdded(i)) {\n          added.push(unref(i))\n        } else {\n          for (const key in i._origin) {\n            if (!isEqual(i[key], i._origin[key])) {\n              changed.push(unref(i))\n              break\n            }\n          }\n        }\n      }\n    }\n\n    return [removed, added, changed] as const\n  }\n\n  const data = computed(() => tableState.data.filter((i) => !i._delete))\n  const editTableState: TableState<T> = reactive({\n    ...tableState,\n    data,\n  })\n\n  return {\n    ...other,\n    tableState: editTableState,\n    setColumn,\n    editRow,\n    delRow,\n    cancelRow,\n    saveRow,\n    addRow,\n    rowIsEditing,\n    getChangedRows,\n    rowIsAdded,\n  }\n}\n"],"names":["useEditTable","opts","renderColumn","useColumn","tableState","other","useTable","i","formatter","editable","row","column","cellValue","index","isUndefined","defaultFormatter","p","res","origin","cloneDeep","readonly","setColumn","prop","obj","editRow","cancelRow","key","delRow","saveRow","addRow","newRow","rowIsEditing","rowIsAdded","getChangedRows","added","changed","removed","unref","isEqual","data","computed","editTableState","reactive"],"mappings":"4NAea,MAAAA,EAAwCC,GAAoD,CACvG,MAAMC,EAAeC,IACf,CAAE,WAAAC,EAAY,GAAGC,CAAA,EAAUC,EAAmC,CAClE,UAAUC,EAAG,CACX,KAAM,CAAE,UAAAC,EAAW,SAAAC,EAAU,GAAGJ,GAAUE,EAEnC,MAAA,CACL,GAAGF,EACH,UAAUK,EAAKC,EAAQC,EAAWC,EAAO,CACvC,OAAKC,EAAYL,CAAQ,GAAKA,IAAa,KAAUC,EAAY,SACxDR,EAAaQ,EAAKH,CAAC,GAAK,GAG7BC,EAAkBA,EAAUE,EAAKC,EAAQC,EAAWC,CAAK,EAEtDE,EAAiBH,EAAWP,EAAM,QAASA,EAAM,YAAY,GAAKO,GAAaP,EAAM,YAC9F,CAAA,CAEJ,EACA,GAAGJ,EACH,MAAM,MAAMe,EAAG,CACb,MAAMC,EAAM,MAAMhB,EAAK,MAAMe,CAAC,EAE9B,OAAAC,EAAI,KAAOA,EAAI,KAAK,IAAKV,GAAM,CACvB,MAAAW,EAASC,EAAUZ,CAAC,EAEnB,OAAA,OAAO,OAAOA,EAAG,CAAE,QAASa,EAASF,CAAM,EAAG,CAAA,CACtD,EAEMD,CACT,CAAA,CACD,EAEKI,EAAY,CAACC,EAAsBC,IAAwC,CAC/EnB,EAAW,QAAUA,EAAW,QAAQ,IAAKG,GACvCA,EAAE,OAASe,EAAa,OAAO,OAAOf,EAAGgB,CAAG,EAEzChB,CACR,CAAA,EAGGiB,EAAWd,GAAW,CAC1BA,EAAI,SAAW,EAAA,EAGXe,EAAaf,GAAW,CACjB,UAAAgB,KAAOhB,EAAI,QACpBA,EAAIgB,CAAc,EAAIhB,EAAI,QAAQgB,CAAG,EAEvChB,EAAI,SAAW,EAAA,EAGXiB,EAAUjB,GAAW,CACzBA,EAAI,QAAU,EAAA,EAGVkB,EAAWlB,GAAW,CAC1BA,EAAI,SAAW,EAAA,EAGXmB,EAAUnB,GAAqB,CAE7B,MAAAoB,EAAY,CAAE,SAAU,GAAM,GAAIpB,GAAO,KAAO,QAAS,QAEpD,OAAAN,EAAA,KAAK,KAAK0B,CAAM,EAEpBA,CAAA,EAGHC,EAAgBrB,GACb,CAAC,CAACA,EAAI,SAGTsB,EAActB,GACXI,EAAYJ,EAAI,OAAO,EAM1BuB,EAAiB,IAAM,CAC3B,MAAMC,EAAa,CAAA,EACbC,EAAe,CAAA,EACfC,EAAe,CAAA,EAEV,UAAA7B,KAAKH,EAAW,KACzB,GAAIG,EAAE,QACCyB,EAAWzB,CAAC,GACP6B,EAAA,KAAKC,EAAM9B,CAAC,CAAC,UAGnByB,EAAWzB,CAAC,EACR2B,EAAA,KAAKG,EAAM9B,CAAC,CAAC,MAER,WAAAmB,KAAOnB,EAAE,QACd,GAAA,CAAC+B,EAAQ/B,EAAEmB,CAAG,EAAGnB,EAAE,QAAQmB,CAAG,CAAC,EAAG,CAC5BS,EAAA,KAAKE,EAAM9B,CAAC,CAAC,EACrB,MAOH,MAAA,CAAC6B,EAASF,EAAOC,CAAO,CAAA,EAG3BI,EAAOC,EAAS,IAAMpC,EAAW,KAAK,OAAQG,GAAM,CAACA,EAAE,OAAO,CAAC,EAC/DkC,EAAgCC,EAAS,CAC7C,GAAGtC,EACH,KAAAmC,CAAA,CACD,EAEM,MAAA,CACL,GAAGlC,EACH,WAAYoC,EACZ,UAAApB,EACA,QAAAG,EACA,OAAAG,EACA,UAAAF,EACA,QAAAG,EACA,OAAAC,EACA,aAAAE,EACA,eAAAE,EACA,WAAAD,CAAA,CAEJ"}