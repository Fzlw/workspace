{"version":3,"file":"VerifyEditTable.stories-3bf61f32.js","sources":["../../../packages/component/src/useVerifyEditTable/index.ts"],"sourcesContent":["import { isUndefined } from 'lodash-es'\nimport { UnwrapRef, computed, h, ref, shallowRef, unref } from 'vue'\nimport { ElFormItem, FormInstance, FormValidateFailure } from 'element-plus'\nimport { ExpandColumn, ExcludeColumn, renderColumn } from '../useColumn'\nimport { UseFormColumn, formatFormColumn } from '../useForm'\nimport { UseTableOptions, defaultFormatter, TableState } from '../useTable'\nimport { UseEditTableColumn, EditTableRow, useEditTable } from '../useEditTable'\n\nexport type UseVerifyEditTableColumn<T> = ExpandColumn<UseEditTableColumn<T>, ExcludeColumn<UseFormColumn, 'hidden'>>\n\nexport type UseVerifyEditTableOptions<T> = UseTableOptions<T, UseVerifyEditTableColumn<T>>\n\nexport interface VerifyTableState<T> {\n  tableState: TableState<T>\n  model: T | null\n  ref?: any\n}\n\nexport function useVerifyEditTable<T extends EditTableRow>(opts: UseVerifyEditTableOptions<T>) {\n  const { tableState, editRow, delRow, cancelRow, saveRow, addRow, ...other } = useEditTable<T>({\n    mapColumn(i) {\n      const { formItemProps, editable, formatter, ...other } = formatFormColumn(i) as UseVerifyEditTableColumn<T>\n\n      return {\n        ...other,\n        label: i.label,\n        formatter(row, column, cellValue, index) {\n          if ((isUndefined(editable) || editable === true) && row?._editing) {\n            return h(\n              ElFormItem,\n              {\n                ...formItemProps,\n                label: '',\n              },\n              { default: () => renderColumn(row, other) ?? '' }\n            )\n          }\n\n          if (formatter) return formatter(row, column, cellValue, index)\n\n          return defaultFormatter(cellValue, other.rFormat, other.defaultValue) ?? cellValue ?? other.defaultValue\n        },\n      }\n    },\n    ...opts,\n  })\n\n  const verifyForm = shallowRef<FormInstance | null>(null)\n  const model = ref<VerifyTableState<T>['model']>(null)\n  const verifyTableState = computed<VerifyTableState<T>>(() => {\n    return {\n      tableState: unref(tableState),\n      model: unref(model) as T,\n      ref(instance: any) {\n        verifyForm.value = instance?.elForm\n      },\n    }\n  })\n\n  const vEditRow: typeof editRow = (row) => {\n    if (unref(model)) return\n\n    model.value = row as UnwrapRef<T>\n\n    editRow(row)\n  }\n\n  const vDelRow: typeof delRow = (row) => {\n    model.value = null\n\n    delRow(row)\n  }\n\n  const vCancelRow: typeof cancelRow = (row) => {\n    model.value = null\n\n    cancelRow(row)\n  }\n\n  const vSaveRow = async (row: T): Promise<[boolean, FormValidateFailure['fields'] | null]> => {\n    try {\n      const valid = await verifyForm.value?.validate?.()\n\n      if (valid) {\n        model.value = null\n\n        saveRow(row)\n      }\n\n      return [!!valid, null]\n    } catch (error) {\n      return [false, error as FormValidateFailure['fields']]\n    }\n  }\n\n  const vAddRow = (row?: T) => {\n    if (unref(model)) return\n\n    const newRow = addRow(row)\n\n    model.value = newRow as UnwrapRef<T>\n\n    return newRow\n  }\n\n  const hasEditingRow = () => {\n    return !!unref(model)\n  }\n\n  return {\n    verifyTableState,\n    form: verifyForm,\n    editRow: vEditRow,\n    delRow: vDelRow,\n    cancelRow: vCancelRow,\n    saveRow: vSaveRow,\n    addRow: vAddRow,\n    hasEditingRow,\n    ...other,\n  }\n}\n"],"names":["useVerifyEditTable","opts","tableState","delRow","cancelRow","saveRow","addRow","i","other","other2","row","column","cellValue","index","isUndefined","editable","h","ElFormItem","formItemProps","renderColumn","formatter","defaultFormatter","verifyForm","shallowRef","model","ref","computed","unref","instance","editRow","valid","_b","_a","error","newRow"],"mappings":"+YAoBiBA,EAAAC,EAAA,CACL,KAAA,CAAA,WAAAC,YAA2B,OAAAC,EAAA,UAAAC,EAAW,QAAAC,EAAS,OAAAC,UAAsB,CAEpE,UAAAC,EAAA,CAAA,KACFC,CAAAA,cAAAA,EAAAA,SAAAA,EAAAA,UAAAA,EAAAA,GAAAA,GAAAA,EAAAA,CAAAA,EAAA,OAEH,GAAUC,EACR,MAAKF,QACI,UAAAG,EAAAC,EAAAC,EAAAC,EAAA,CACL,OAAAC,EAAAC,CAAA,GAAAA,IAAA,MAAAL,GAAA,MAAAA,EAAA,UACAM,EAAAC,EACK,CAEL,GAAAC,EACE,MAAS,EACb,EACF,CAAA,QAAA,IAAAC,EAAAT,EAAAD,CAAA,GAAA,EAAA,CAEA,EAEOW,EACTA,EAAAV,EAAAC,EAAAC,EAAAC,CAAA,EACFQ,EAAAT,EAAAH,EAAA,QAAAA,EAAA,YAAA,GAAAG,GAAAH,EAAA,YACF,CAAA,CAED,EAEK,GAAAR,CACN,CAAM,EACAqB,EAAAC,MAAiD,EAC9CC,EAAAC,EAAA,IAAA,EA4DP,MACM,CACN,iBA7D8BC,EAAA,KAC5B,CACA,WAAmBC,EAAAzB,CAAA,EACjB,MAAAyB,EAAWH,GACb,IAAAI,EAAA,CACFN,EAAA,MAAAM,GAAA,YAAAA,EAAA,MACD,CAED,EACE,EAqDA,KAAQN,EACR,QAtDkBZ,GAAA,CAElBiB,EAAcH,CAAA,IAGhBA,EAAA,MAAAd,EAEMmB,EAAAnB,CAAA,EACJ,EA+CA,OA7CUA,GAAA,CACZc,EAAA,MAAA,KAEMrB,EAAAO,CAAA,CACJ,EA0CA,UAxCaA,GAAA,CACfc,EAAA,MAAA,KAEMpB,EAAAM,CAAA,CACJ,EAqCA,QApCgB,MAAMA,GAAW,SAE/B,GAAA,CACE,MAAAoB,EAAc,OAAAC,GAAAC,EAAAV,EAAA,QAAA,YAAAU,EAAA,WAAA,YAAAD,EAAA,KAAAC,IAEd,OAAAF,IACFN,EAAA,MAAA,KAEAnB,EAAUK,CAAA,GAEH,CAAC,IAA6C,IAAA,CACvD,OAAAuB,EAAA,CACF,MAAA,CAAA,GAAAA,CAAA,CAEM,CACJ,EAsBA,OAtBkBvB,GAAA,CAEZ,GAAAiB,EAAAH,CAAS,EAEf,OAEO,MAAAU,EAAA5B,EAAAI,CAAA,EACT,OAAAc,EAAA,MAAAU,GAGE,EAaF,cAZA,IAEO,CAAA,CAAAP,EAAAH,CAAA,EAWT,GAAAhB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;"}